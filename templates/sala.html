{% extends "panel-header.html" %}

{% block head_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
{% endblock %}

{% block content %}

{# --- 1. CONFIGURACIÃ“N --- #}
{% set params = "room=" ~ room %}
{% if password %}{% set params = params ~ "&password=" ~ password %}{% endif %}
{% set bgRoom = room ~ "_bg" %}
{% set bgPushUrl = "https://vdo.ninja/?room=" ~ bgRoom ~ "&push&autostart&webcam&quality=0&videobitrate=6000&width=1920&height=1080&framerate=30&codec=vp9" %}
{% set bgViewUrl = "https://vdo.ninja/?room=" ~ bgRoom ~ "&scene&autoplay&muted&cleanoutput&noheader&nocontrols&transparent&quality=0" %}

{# --- 2. INTERFAZ --- #}
<h1>Sala: {{ room }} <small>({{ username }}{% if is_host %} - Host{% endif %})</small></h1>


<div id="avi-tools">
    <button type="button" class="active" data-mode="move" title="Mover objetos">âœ‹ Mover</button>

    <button id="btn-draw" type="button" data-mode="draw" title="LÃ¡piz">âœï¸ Dibujar</button>
    <button id="btn-eraser" type="button" title="Borrador">ğŸ§¼ Borrar</button>
    <button id="btn-clear" type="button" class="btn-red" title="Limpiar Pizarra">ğŸ—‘ï¸ Limpiar</button>

    <button id="btn-magic-wand" type="button" title="Controlar con el dedo">ğŸª„ Varita IA</button>

    <span class="divider"></span>

    <button id="btn-chat" type="button" style="position: relative;">
        ğŸ’¬ Chat
        <span id="chat-badge" class="badge hidden">0</span>
    </button>

    <a href="{{ bgPushUrl }}" target="_blank" style="text-decoration: none;">
        <button type="button" class="btn-purple">ğŸ“º Emitir Fondo</button>
    </a>

    {% if is_host %}
    <span class="divider"></span>
    <button id="btn-stats" type="button" title="Ver EstadÃ­sticas">ğŸ“Š Logs</button>
    {% endif %}
</div>

<div id="chat-panel" class="hidden">
    <div class="chat-header">
        <span>ğŸ’¬ Aula Interactiva</span>
        <button id="btn-close-chat">âœ–</button>
    </div>

    <div class="chat-actions-bar">
        <button id="btn-share" class="btn-mini btn-green" title="Copiar enlace">ğŸ”— Invitar</button>
        <button id="btn-hand" class="btn-mini btn-yellow" title="Levantar mano">âœ‹ Mano</button>
        <button id="btn-reactions" class="btn-mini" title="Reaccionar">ğŸ˜Š ReacciÃ³n</button>
    </div>

    <div id="reaction-panel" class="hidden">
        <span>â¤ï¸</span><span>ğŸ‘</span><span>ğŸ‘</span><span>ğŸ˜¢</span><span>ğŸ˜‚</span><span>ğŸ˜®</span>
    </div>

    <div id="chat-messages">
        <div class="message system">
            <small>Bienvenido. Usa la barra superior para invitar o reaccionar.</small>
        </div>
    </div>

    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Escribe un mensaje..." autocomplete="off">
        <button id="btn-send-chat">â¤</button>
    </div>
</div>


<div id="avi-stage">
  <div id="avi-background" class="avi-layer">
      <iframe src="{{ bgViewUrl }}" allow="autoplay; muted" style="width: 100%; height: 100%; border: 0; pointer-events: none;"></iframe>
  </div>

  <div id="avi-participants" class="avi-layer"></div>
  <canvas id="avi-whiteboard"></canvas>
  <canvas id="magic-canvas"></canvas>
</div>

{# Modales y Notificaciones #}
{% if is_host %}
<div id="stats-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>ğŸ“Š EstadÃ­sticas de la Clase</h3>
        <div style="position: relative; height:300px; width:100%">
            <canvas id="chart-canvas"></canvas>
        </div>
        <button id="btn-close-stats" class="btn-red" style="margin-top: 15px;">Cerrar</button>
    </div>
</div>
{% endif %}

<div id="toast-container"></div>

{# --- 3. VARIABLES Y SCRIPTS --- #}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

<script>
    const ROOM_ID = "{{ room }}";
    const USER_NAME = "{{ username|default('Invitado') }}";
    const IS_HOST = {{ 'true' if is_host else 'false' }};
</script>

<script src="{{ url_for('static', filename='js/sala_socket.js') }}"></script>
<script src="{{ url_for('static', filename='js/sala_ui.js') }}"></script>
<script src="{{ url_for('static', filename='js/varita_magica.js') }}"></script>

{% endblock %}